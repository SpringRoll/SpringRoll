/*! SpringRoll 0.3.15 */
!function(){"use strict";!function(){function a(a,b){return a.start-b.start}var b,c,d,e,f,g,h,i=include("createjs.Container"),j=function(a){if(d||(b=include("springroll.Debug",!1),d=include("springroll.Application"),e=include("springroll.LoadTask"),f=include("springroll.TaskManager"),g=include("springroll.Sound"),h=include("springroll.ListTask"),c=include("springroll.easeljs.BitmapUtils")),i.call(this),!a)throw new Error("need options to create Cutscene");this.isReady=!1,this.framerate=0,this.display="string"==typeof a.display?d.instance.getDisplay(a.display):a.display,this.config=a.configUrl,this.imageScale=a.imageScale||1,this.pathReplaceTarg=a.pathReplaceTarg||null,this.pathReplaceVal=a.pathReplaceVal||null,this._taskMan=null,this._elapsedTime=0,this._audioAliases=null,this._audio=null,this._audioIndex=0,this._audio=null,this._clip=null,this._activeSyncAudio=[],this._soundStartTime=-1,this._activeAudio=[],this._animFinished=!1,this._audioFinished=!1,this._captionsObj=a.captions||null,this._captionsObj&&(this._captionsObj.selfUpdate=!1),this._loadCallback=a.loadCallback||null,this._endCallback=null,this._libItemsToUnload=[],this._imagesToUnload=[],this.update=this.update.bind(this),this.resize=this.resize.bind(this),this.setup()},k=extend(j,i);k.setup=function(){this.display.stage.addChild(this),this._taskMan=new f([new e("config",this.config,this.onConfigLoaded.bind(this))]),this._taskMan.on(f.ALL_TASKS_DONE,this.onLoadComplete.bind(this)),this._taskMan.startAll()},k.onConfigLoaded=function(b){this.config=b.content,this.framerate=this.config.settings.fps;var c=[];c.push({id:"clip",src:this.config.settings.clip});var d;for(var e in this.config.images)d=this.pathReplaceTarg?this.config.images[e].replace(this.pathReplaceTarg,this.pathReplaceVal):this.config.images[e],c.push({id:e,src:d});if(this._taskMan.addTask(new h("art",c,this.onArtLoaded.bind(this))),this.config.settings.audioAlias)this._audioAliases=[this.config.settings.audioAlias],this._audio=[{alias:this.config.settings.audioAlias,start:0,sync:!0}];else{if(!this.config.settings.audio)return;this._audio=this.config.settings.audio.slice(),this._audio.sort(a),this._audioAliases=[];for(var f=0,i=this._audio.length;i>f;++f)-1==this._audioAliases.indexOf(this._audio[f].alias)&&this._audioAliases.push(this._audio[f].alias)}this._audioAliases.length&&this._taskMan.addTask(g.instance.createPreloadTask("audio",this._audioAliases,this.onAudioLoaded))},k.onAudioLoaded=function(){},k.onArtLoaded=function(a){window.images||(window.images={});var b,d,e,f,g={},h={};for(b in a)if(d=a[b].content,0===b.indexOf("atlasData_"))g[b.replace("atlasData_","")]=d;else if(0===b.indexOf("atlasImage_"))h[b.replace("atlasImage_","")]=d;else if("clip"==b){var i=d.text;if(!i)continue;for(var j=i.split(/[\(!]function\s*\(/),k=0;k<j.length;++k)if(i=j[k]){var l=i.substring(0,i.indexOf(","));if(l)for(var m=new RegExp("\\("+l+".(\\w+)\\s*=","g"),n=m.exec(i);n;)this._libItemsToUnload.push(n[1]),n=m.exec(i)}if(1!=this.imageScale){e=this.imageScale;for(f in this.config.images)c.replaceWithScaledBitmap(f,e)}}else images[b]=d,this._imagesToUnload.push(b);for(b in g)g[b]&&h[b]&&(c.loadSpriteSheet(g[b],h[b],this.imageScale),this._imagesToUnload.push(h[b]))},k.onLoadComplete=function(a){this._taskMan.off(),this._taskMan.destroy(),this._taskMan=null;var b=this._clip=new lib[this.config.settings.clipClass];this._clip.timeline&&1!=this._clip.timeline.duration||(b=this._clip.getChildAt(0)),b.mouseEnabled=!1,b.framerate=this.framerate,b.tickEnabled=!1,b.gotoAndPlay(0),b.loop=!1,this.addChild(this._clip),this.resize(this.display.width,this.display.height),d.instance.on("resize",this.resize),this.isReady=!0,this._loadCallback&&(this._loadCallback(),this._loadCallback=null)},k.resize=function(a,b){if(this._clip){var c,d=this.config.settings,e=d.designedWidth/d.designedHeight,f=a/b;e>f?(c=a/d.designedWidth,this.x=0,this.y=.5*(b-d.designedHeight*c)):(c=b/d.designedHeight,this.x=.5*(a-d.designedWidth*c),this.y=0),this._clip.scaleX=this._clip.scaleY=c}},k.start=function(a){this._endCallback=a,this._elapsedTime=0,this._animFinished=!1,this._audioFinished=!1;for(var b=0;b<this._audio.length;++b){var c=this._audio[b];if(0!==c.start)break;var e=c.alias,f={};if(c.sync){var h=g.instance.play(e,this._audioCallback.bind(this,f));this._activeSyncAudio.unshift(h),f.instance=h,h._audioData=c,this._soundStartTime=c.start,this._captionsObj&&this._captionsObj.play(e)}else{var i=g.instance.play(e,this._audioCallback.bind(this,f));f.instance=i,this._activeAudio.push(i)}++this._audioIndex}d.instance.on("update",this.update)},k._audioCallback=function(a){var b=this._activeSyncAudio.indexOf(a.instance);if(-1!=b)if(0===b?this._activeSyncAudio.shift():this._activeSyncAudio.splice(b,1),this._activeSyncAudio.length<1)this._audioFinished=!0,this._soundStartTime=-1,this._captionsObj&&this._captionsObj.stop(),this._animFinished&&this.stop(!0);else{var c=this._activeSyncAudio[0]._audioData;this._soundStartTime=c.start,this._captionsObj&&this._captionsObj.play(c.alias)}else b=this._activeAudio.indexOf(a.instance),-1!=b&&this._activeAudio.splice(b,1)},k.update=function(a){if(!this._animFinished){this._activeSyncAudio.length||(this._elapsedTime+=.001*a);for(var b=this._audioIndex;b<this._audio.length;++b){var c=this._audio[b];if(!(c.start<=this._elapsedTime))break;var d=c.alias,e={};if(c.sync){this._audioFinished=!1;var f=g.instance.play(d,this._audioCallback.bind(this,e));this._activeSyncAudio.unshift(f),e.instance=f,f._audioData=c,this._soundStartTime=c.start,this._captionsObj&&this._captionsObj.play(d)}else{var h=g.instance.play(d,{complete:this._audioCallback.bind(this,e),offset:1e3*(this._elapsedTime-c.start)});e.instance=h,this._activeAudio.push(h)}++this._audioIndex}if(this._activeSyncAudio.length){var i=.001*this._activeSyncAudio[0].position;0===this._elapsedTime&&i>2*a||(this._elapsedTime=this._soundStartTime+i)}if(this._captionsObj&&this._soundStartTime>=0&&this._captionsObj.seek(this._activeSyncAudio[0].position),!this._animFinished){var j=this._clip.timeline&&1!=this._clip.timeline.duration?this._clip:this._clip.getChildAt(0);j.elapsedTime=this._elapsedTime,j.advance(),j.currentFrame==j.timeline.duration&&(this._animFinished=!0,this._audioFinished&&this.stop(!0))}}},k.stop=function(a){d.instance.off("update",this.update);var b;for(b=0;b<this._activeSyncAudio.length;++b)this._activeSyncAudio[b].stop();for(b=0;b<this._activeAudio.length;++b)this._activeAudio[b].stop();this._captionsObj&&this._captionsObj.stop(),a&&this._endCallback&&(this._endCallback(),this._endCallback=null)},k.destroy=function(){d.instance.off("resize",this.resize),this.removeAllChildren(!0),g.instance.unload(this._audioAliases);var a;for(a=this._libItemsToUnload.length-1;a>=0;--a)delete lib[this._libItemsToUnload[a]];for(a=this._imagesToUnload.length-1;a>=0;--a){var b=this._imagesToUnload[a];"string"==typeof b?(images[b].src="",delete images[b]):b.src=""}this._libItemsToUnload=this._imagesToUnload=this.config=null,this._taskMan&&(this._taskMan.off(),this._taskMan.destroy(),this._taskMan=null),this._activeSyncAudio=this._activeAudio=this._audioAliases=this._audio=null,this._loadCallback=this._endCallback=this._clip=this._captionsObj=null,this.parent&&this.parent.removeChild(this),this.display=null},namespace("springroll").Cutscene=j,namespace("springroll.easeljs").Cutscene=j}();}();