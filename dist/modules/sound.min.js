/*! CloudKidFramework 0.0.3 */
!function(){"use strict";function a(){document.removeEventListener("touchstart",a),createjs.WebAudioPlugin.playEmptySound()}var b=cloudkid.Application,c=cloudkid.MediaLoader,d=cloudkid.LoadTask,e=cloudkid.Task,f=cloudkid.TaskManager,g=function(){this._sounds={},this._fades=[],this._contexts={},this._pool=[],this._update=this._update.bind(this),this._markLoaded=this._markLoaded.bind(this),this._playAfterLoadBound=this._playAfterLoad.bind(this)},h=g.prototype={},i=null;h._sounds=null,h._fades=null,h._pool=null,h.supportedSound=null,h._contexts=null;var j=0,k=1,l=2;g.UNHANDLED="unhandled",g.init=function(b,c,d){if(createjs.Sound.registerPlugins(b),createjs.Sound.BrowserDetect.isIOS&&document.addEventListener("touchstart",a),i=new g,createjs.Sound.getCapabilities())i._initComplete(c,d);else if(createjs.Sound.activePlugin){var e;e=function(){createjs.Sound.getCapabilities()&&(cloudkid.Application.instance.off("update",e),i._initComplete(c,d))},cloudkid.Application.instance.on("update",e)}else Debug.error("Unable to initialize SoundJS with a plugin!");return i},h._initComplete=function(a,b){if(createjs.FlashPlugin&&createjs.Sound.activePlugin instanceof createjs.FlashPlugin)i.supportedSound=".mp3";else for(var c=0;c<a.length;++c){var d=a[c];if(createjs.Sound.getCapability(d)){i.supportedSound="."+d;break}}b&&b()},Object.defineProperty(g,"instance",{get:function(){return i}}),h.loadConfig=function(a,b){if(!a)return void Debug.warn("Warning - cloudkid.Sound was told to load a null config");var c=a.soundManifest,d=a.path;b=b||a.context;for(var e=0,f=c.length;f>e;++e){var g=c[e];"string"==typeof g&&(g={id:g});var h=this._sounds[g.id]={id:g.id,src:d+(g.src?g.src:g.id)+this.supportedSound,volume:g.volume?g.volume:1,state:j,playing:[],waitingToPlay:[],context:g.context||b,playAfterLoad:!1,preloadCallback:null,data:g};h.context&&(this._contexts[h.context]||(this._contexts[h.context]=new o(h.context)),this._contexts[h.context].sounds.push(h))}},h.exists=function(a){return!!this._sounds[a]},h.isUnloaded=function(a){return this._sounds[a]?this._sounds[a].state==j:!1},h.isLoaded=function(a){return this._sounds[a]?this._sounds[a].state==l:!1},h.isLoading=function(a){return this._sounds[a]?this._sounds[a].state==k:!1},h.isPlaying=function(a){var b=this._sounds[a];return b?b.playing.length+b.waitingToPlay.length>0:!1},h.fadeIn=function(a,c,d,e){var f,g;if("string"==typeof a){if(f=this._sounds[a],!f)return;f.playing.length&&(g=f.playing[f.playing.length-1])}else g=a,f=this._sounds[g.alias];if(g&&g._channel){g._fTime=0,g._fDur=c>0?c:500;var h=e>0?e:0;g._channel.setVolume(h),g.curVol=g._fStart=h,g._fEnd=d||f.volume,-1==this._fades.indexOf(g)&&(this._fades.push(g),1==this._fades.length&&b.instance.on("update",this._update))}},h.fadeOut=function(a,c,d,e){var f,g;if("string"==typeof a){if(f=this._sounds[a],!f)return;f.playing.length&&(g=f.playing[f.playing.length-1])}else g=a;g&&g._channel&&(g._fTime=0,g._fDur=c>0?c:500,e>0?(g._channel.setVolume(e),g._fStart=e):g._fStart=g._channel.getVolume(),g.curVol=g._fStart,g._fEnd=d||0,-1==this._fades.indexOf(g)&&(this._fades.push(g),1==this._fades.length&&b.instance.on("update",this._update)))},h._update=function(a){for(var c=this._fades,d=0,e=c.length-1;e>=0;--e){var f=c[e];if(!f.paused){var g=f._fTime+=a;if(g>=f._fDur){if(0===f._fEnd){var h=this._sounds[f.alias];h.playing=h.playing.splice(h.playing.indexOf(f),1),this._stopInst(f)}else f.curVol=f._fEnd,f.updateVolume();++d;var i=c.length-d;e!=i&&(c[e]=c[i])}else{var j,k=g/f._fDur;j=f._fEnd>f._fStart?f._fStart+(f._fEnd-f._fStart)*k:f._fEnd+(f._fStart-f._fEnd)*k,f.curVol=j,f.updateVolume()}}}c.length=c.length-d,0===c.length&&b.instance.off("update",this._update)},h.play=function(a,b,d,e,f,h,i,m,n){if(i===!0&&(i=-1),b==g.UNHANDLED)return createjs.Sound.play(a,e,f,h,i,m,n);var o=this._sounds[a];if(!o)return Debug.error("cloudkid.Sound: sound "+a+" not found!"),void(b&&b());var p,q,r=o.state;if(m="number"==typeof m&&m>0?m:o.volume,r==l){var s=createjs.Sound.play(a,e,f,h,i,m,n);return s&&s.playState!=createjs.Sound.PLAY_FAILED?(p=this._getSoundInst(s,o.id),s.handleExtraData&&s.handleExtraData(o.data),p.curVol=m,o.playing.push(p),p._endCallback=b,p.updateVolume(),p.length=s.getDuration(),p._channel.addEventListener("complete",p._endFunc),d&&setTimeout(d,0),p):(b&&b(),null)}return r==j?(o.state=k,o.playAfterLoad=!0,p=this._getSoundInst(null,o.id),p.curVol=m,o.waitingToPlay.push(p),p._endCallback=b,p._startFunc=d,p._startParams?(q=p._startParams,q[0]=e,q[1]=f,q[2]=h,q[3]=i,q[4]=n):p._startParams=[e,f,h,i,n],c.instance.load(o.src,this._playAfterLoadBound,null,0,o),p):r==k?(o.playAfterLoad=!0,p=this._getSoundInst(null,o.id),p.curVol=m,o.waitingToPlay.push(p),p._endCallback=b,p._startFunc=d,p._startParams?(q=p._startParams,q[0]=e,q[1]=f,q[2]=h,q[3]=i,q[4]=n):p._startParams=[e,f,h,i,n],p):void 0},h._getSoundInst=function(a,b){var c;return this._pool.length?c=this._pool.pop():(c=new m,c._endFunc=this._onSoundComplete.bind(this,c)),c._channel=a,c.alias=b,c.length=a?a.getDuration():0,c.isValid=!0,c},h._playAfterLoad=function(a){var b="string"==typeof a?a:a.id,c=this._sounds[b];if(c.state=l,c.playAfterLoad){for(var d=c.waitingToPlay,e=0;e<d.length;++e){var f=d[e],g=f._startParams,h=f.curVol,i=createjs.Sound.play(b,g[0],g[1],g[2],g[3],h,g[4]);i&&i.playState!=createjs.Sound.PLAY_FAILED?(c.playing.push(f),f._channel=i,i.handleExtraData&&i.handleExtraData(c.data),f.length=i.getDuration(),f.updateVolume(),i.addEventListener("complete",f._endFunc),f._startFunc&&f._startFunc(),f.paused&&i.pause()):(f._endCallback&&f._endCallback(),this._poolInst(f))}d.length=0}},h._onSoundComplete=function(a){a._channel.removeEventListener("complete",a._endFunc);var b=this._sounds[a.alias];b.playing.splice(b.playing.indexOf(a),1);var c=a._endCallback;this._poolInst(a),c&&c()},h.stop=function(a){var b=this._sounds[a];if(b)if(b.playing.length)this._stopSound(b);else if(b.state==k){b.playAfterLoad=!1;for(var c=b.waitingToPlay,d=0;d<c.length;++d){var e=c[d];this._poolInst(e)}c.length=0}},h._stopSound=function(a){for(var b=a.playing,c=b.length-1;c>=0;--c)this._stopInst(b[c]);b.length=0},h._stopInst=function(a){a._channel.removeEventListener("complete",a._endFunc),a._channel.stop(),this._poolInst(a)},h.stopContext=function(a){if(a=this._contexts[a])for(var b=a.sounds,c=b.length-1;c>=0;--c){var d=b[c];d.playing.length?this._stopSound(d):d.state==k&&(d.playAfterLoad=!1)}},h.pauseSound=function(a){var b;b="string"==typeof a?this._sounds[a]:a;for(var c=b.playing,d=c.length-1;d>=0;--d)c[d].pause()},h.unpauseSound=function(a){var b;b="string"==typeof a?this._sounds[a]:a;for(var c=b.playing,d=c.length-1;d>=0;--d)c[d].unpause()},h.pauseAll=function(){var a=this._sounds;for(var b in a)this.pauseSound(a[b])},h.unpauseAll=function(){var a=this._sounds;for(var b in a)this.unpauseSound(a[b])},h.setContextMute=function(a,b){if(a=this._contexts[a]){a.muted=b;for(var c=a.volume,d=a.sounds,e=d.length-1;e>=0;--e){var f=d[e];if(f.playing.length)for(var g=f.playing,h=g.length-1;h>=0;--h)g[h].updateVolume(b?0:c)}}},h.setContextVolume=function(a,b){if(a=this._contexts[a]){var c=a.muted;a.volume=b;for(var d=a.sounds,e=d.length-1;e>=0;--e){var f=d[e];if(f.playing.length)for(var g=f.playing,h=g.length-1;h>=0;--h)g[h].updateVolume(c?0:b)}}},h.preloadSound=function(a,b){var d=this._sounds[a];return d?void(d.state==j&&(d.state=k,d.preloadCallback=b||null,c.instance.load(d.src,this._markLoaded,null,0,d))):void Debug.error("Sound does not exist: "+a+" - can't preload!")},h.preload=function(a,b){if(!a||0===a.length)return void(b&&b());for(var c=[],e=0,g=a.length;g>e;++e){var h=this._sounds[a[e]];h?h.state==j&&(h.state=k,c.push(new d(h.id,h.src,this._markLoaded,null,0,h))):Debug.error("cloudkid.Sound was asked to preload "+a[e]+" but it is not a registered sound!")}c.length>0?f.process(c,function(){b&&b()}):b&&b()},h._markLoaded=function(a){var b=a.id,c=this._sounds[b];c&&(c.state=l,c.playAfterLoad&&this._playAfterLoad(b));var d=c.preloadCallback;d&&(c.preloadCallback=null,d())},h.createPreloadTask=function(a,b,c){return n?new n(a,b,c):null},h.unload=function(a){if(a)for(var b=0,c=a.length;c>b;++b){var d=this._sounds[a[b]];d&&(this._stopSound(d),d.state=j),createjs.Sound.removeSound(a[b])}},h._poolInst=function(a){a._endCallback=null,a.alias=null,a._channel=null,a._startFunc=null,a.curVol=0,a.paused=!1,a.isValid=!1,this._pool.push(a)},h.destroy=function(){i=null,this._volumes=null,this._fades=null,this._contexts=null,this._pool=null};var m=function(){this._channel=null,this._endFunc=null,this._endCallback=null,this._startFunc=null,this._startParams=null,this.alias=null,this._fTime=0,this._fDur=0,this._fStart=0,this._fEnd=0,this.curVol=0,this.length=0,this.paused=!1,this.isValid=!0};Object.defineProperty(m.prototype,"position",{get:function(){return this._channel?this._channel.getPosition():0}}),m.prototype.stop=function(){var a=g.instance,b=a._sounds[this.alias];b.playing.splice(b.playing.indexOf(this),1),g.instance._stopInst(this)},m.prototype.updateVolume=function(a){if(this._channel){if(void 0===a){var b=g.instance,c=b._sounds[this.alias];if(c.context){var d=b._contexts[c.context];a=d.muted?0:d.volume}else a=1}this._channel.setVolume(a*this.curVol)}},m.prototype.pause=function(){this.paused||(this.paused=!0,this._channel&&this._channel.pause())},m.prototype.unpause=function(){this.paused&&(this.paused=!1,this._channel&&this._channel.resume())};var n;e&&(n=function(a,b,c){this.initialize(a,c),this.list=b},n.prototype=Object.create(e.prototype),n.s=e.prototype,n.prototype.start=function(a){i.preload(this.list,a)},n.prototype.destroy=function(){n.s.destroy.apply(this),this.list=null});var o=function(a){this.id=a,this.volume=1,this.muted=!1,this.sounds=[]};o.prototype={},namespace("cloudkid").Sound=g}(),function(){"use strict";var a,b,c=cloudkid.Sound,d=function(c){a=cloudkid.Captions,b=cloudkid.Application,this._audioListener=this._onAudioFinished.bind(this),this._update=this._update.bind(this),this._updateCaptionPos=this._updateCaptionPos.bind(this),c&&(this.captions=c instanceof a?c:new a,this.captions.isSlave=!0),this._listHelper=[]},e=d.prototype={};e.trackAudio=!1,e.audioList=null,e._listCounter=0,e._currentAudio=null,e._audioInst=null,e._callback=null,e._cancelledCallback=null,e._audioListener=null,e._playedAudio=null,e._timer=0,e.captions=null,e._listHelper=null,Object.defineProperty(e,"playing",{get:function(){return null!==this._currentAudio||this._timer>0}}),e.play=function(a,b,c){this.stop(),this._listCounter=-1,this._listHelper[0]=a,this.audioList=this._listHelper,this._callback=b,this._cancelledCallback=c,this._onAudioFinished()},e.playList=function(a,b,c){this.stop(),this._listCounter=-1,this.audioList=a,this._callback=b,this._cancelledCallback=c,this._onAudioFinished()},e._onAudioFinished=function(){if(b.instance.off("update",this._update),b.instance.off("update",this._updateCaptionPos),this.captions&&this._audioInst&&this.captions.seek(this._audioInst.length),this._audioInst=null,this._listCounter++,this._listCounter>=this.audioList.length){this.captions&&this.captions.stop(),this._currentAudio=null,this._cancelledCallback=null;var a=this._callback;this._callback=null,a&&a()}else this._currentAudio=this.audioList[this._listCounter],"string"==typeof this._currentAudio?this._playAudio():"function"==typeof this._currentAudio?(this._currentAudio(),this._onAudioFinished()):(this._timer=this._currentAudio,this._currentAudio=null,b.instance.on("update",this._update))},e._update=function(a){this.captions&&this.captions.updateTime(a),this._timer-=a,this._timer<=0&&this._onAudioFinished()},e._updateCaptionPos=function(){this._audioInst&&this.captions.seek(this._audioInst.position)},e._playAudio=function(){this.trackAudio&&(this._playedAudio?-1==this._playedAudio.indexOf(this._currentAudio)&&this._playedAudio.push(this._currentAudio):this._playedAudio=[this._currentAudio]);var a=c.instance;!a.exists(this._currentAudio)&&this.captions&&this.captions.hasCaption(this._currentAudio)?(this.captions.play(this._currentAudio),this._timer=this.captions.currentDuration,this._currentAudio=null,b.instance.on("update",this._update)):(this._audioInst=a.play(this._currentAudio,this._audioListener),this.captions&&(this.captions.play(this._currentAudio),b.instance.on("update",this._updateCaptionPos)));for(var d=this._listCounter+1;d<this.audioList.length;++d){var e=this.audioList[d];if("string"==typeof e){a.isLoaded(e)||a.preloadSound(e);break}}},e.stop=function(){this._currentAudio&&(c.instance.stop(this._currentAudio),this._currentAudio=null),this.captions&&this.captions.stop(),b.instance.off("update",this._update),b.instance.off("update",this._updateCaptionPos),this.audioList=null,this._timer=0,this._callback=null;var a=this._cancelledCallback;this._cancelledCallback=null,a&&a()},e.unloadPlayedAudio=function(){c.instance.unload(this._playedAudio),this._playedAudio=null},e.destroy=function(){this.stop(),this.audioList=null,this._listHelper=null,this._currentAudio=null,this._audioInst=null,this._callback=null,this._cancelledCallback=null,this._audioListener=null,this._playedAudio=null,this.captions&&(this.captions.destroy(),this.captions=null)},namespace("cloudkid").VOPlayer=d,namespace("cloudkid").Sound.VOPlayer=d}();